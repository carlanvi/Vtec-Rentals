<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VTEC RENTALS</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Zilla+Slab:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    body {
      font-family: 'Zilla Slab', serif;
      margin: 0;
      padding: 0;
      background-color: #FFFF;
    }

    .header-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 48px;
      background-color: #F1C232;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .header-title {
      font-family: 'Zilla Slab', serif;
      font-size: 26px;
      font-weight: bold;
      background: linear-gradient(90deg, #007BFF, #007BFF, #2E8B57, #2E8B57);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
      white-space: nowrap;
      text-align: center;
    }

    .menu-button {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      background-color: #E6B422;
      color: #F4C2C2;
      border: none;
      border-radius: 0px;
      cursor: pointer;
      height: 48px;
      width: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      padding: 0;
    }

    .menu {
      position: fixed;
      top: 48px;
      left: 0;
      width: 150px;
      background-color: rgba(0, 0, 0, 0.8);
      color: #E6B422;
      padding: 20px;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      height: auto;
      min-height: 100px;
      z-index: 999;
    }

    .menu.show {
      transform: translateX(0);
    }

    .menu a {
      display: block;
      color: white;
      margin-bottom: 15px;
      text-decoration: none;
      font-weight: bold;
      cursor: pointer;
    }

    h1 {
      text-align: center;
      color: #6200ea;
      margin-top: 80px;
    }

    form {
      max-width: 400px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    }

    form input,
    form select,
    form button {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    form button {
      background-color: #6200ea;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    form button:hover {
      background-color: #3700b3;
    }

    #bookingMessage {
      text-align: center;
      font-weight: bold;
      color: green;
      margin-top: 20px;
    }

    .gallery-category {
      margin-top: 40px;
    }

    .gallery-category h3 {
      text-align: center;
      margin-bottom: 15px;
      font-size: 22px;
      color: #6200ea;
      text-transform: uppercase;
    }

    .gallery-wrapper {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 10px;
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    @media (min-width: 768px) { /* Adjust the width as per your design */
  .gallery-grid {
    grid-template-columns: repeat(3, 1fr);  /* 3 columns on desktop */
  }
    }

@media (max-width: 600px) {
  #card-element {
    width: 100%;
    max-width: 90%;
  }
  
  .payment-button {
    width: 100%;
    max-width: 90%;
  }
}

    .gallery-grid img {
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
      width: 100%;
      height: 230px;
      object-fit: cover;
    }

    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    .menu a.admin-button {
      background-color: #6A0DAD;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
      font-weight: bold;
      display: block;
      margin: 50px auto 0;
      cursor: pointer;
      transition: background-color 0.3s ease;
      text-align: center;
      width: fit-content;
    }

    .menu a.admin-button:hover {
      background-color: #3700b3;
    }

    .add-to-cart-button {
      position: absolute;
      right: 0px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #E6B422;
      color: red;
      border: none;
      padding: 0;
      border-radius: 0px;
      cursor: pointer;
      height: 48px;
      width: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      text-decoration: none;
    }

    .separator-line {
      border-bottom: 2px solid purple;
      margin: 20px 0;
    }

    .product-card {
      background: #FCE8A8;
      border: 1px solid #eee;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 10px;
      text-align: center;
    }

    .product-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .product-info {
      margin-top: 5px;
    }

    .product-name {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .product-price {
      color: #6200ea;
      margin-bottom: 6px;
    }

    .product-card button {
      background-color: #EFB034;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    
/* Cart Modal Styling */
    #cartModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 2000;
    }

    #cartModal > div {
      background: white;
      max-width: 320px;
      margin: 80px auto;
      border-radius: 12px;
      padding: 15px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-family: 'Zilla Slab', serif;
      max-height: 70vh;
      overflow-y: auto;
    }

    input,
textarea {
  width: 100%;            /* Ensure input takes full width of the container */
  padding: 10px;          /* Add padding for better user experience */
  margin: 5px 0;          /* Space between input fields */
  border-radius: 5px;     /* Rounded corners */
  border: 1px solid #ccc; /* Light border */
  box-sizing: border-box; /* Ensure padding and border are included in width */
  font-size: 16px;        /* Font size for better readability */
}

    #cartModal h2 {
      margin-top: 0;
      text-align: center;
      color: #6200ea;
    }

    #cartItemsContainer > div {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    #cartItemsContainer img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 10px;
    }

    #cartItemsContainer span {
      font-weight: normal;
    }

    #cartItemsContainer div > div {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-grow: 1;
    }

    #cartButtons {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }

    #cartButtons button {
      flex: 1;
      padding: 10px 0;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Zilla Slab', serif;
      font-size: 16px;
      margin: 0 5px;
      transition: background-color 0.3s ease;
    }

    #checkoutBtn {
      background-color: #6200ea;
      color: white;
    }

    #checkoutBtn:hover {
      background-color: #3700b3;
    }

    #closeCartBtn {
      background-color: #ccc;
      color: black;
    }

    #closeCartBtn:hover {
      background-color: #999;
    }



    input.error {
  border: 2px solid red;
  background-color: #fff4f4;
}

  /* Styling for Stripe Elements card input */
  #card-element {
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 12px;
    font-size: 16px;
    width: 100%;
    max-width: 400px;
    box-sizing: border-box;
    margin: 10px auto;
  }

  /* Improve focus effect */
  #card-element:focus {
    border-color: #4CAF50; /* Green border color on focus */
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
  }

  /* Pay Now button styling */
  .payment-button {
    padding: 12px 20px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    background-color: #f0c14b;
    color: #333;
    border-radius: 5px;
    transition: background-color 0.3s ease, transform 0.2s ease;
    width: 100%;
    max-width: 250px;
    margin: 20px auto;
  }

  .payment-button:hover {
    background-color: #e3a300;
    transform: translateY(-3px);
  }

  /* Container styling for better presentation */
  #paymentOptionsModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    text-align: center;
    display: none;
  }

  #paymentOptionsModal h2 {
    margin-bottom: 20px;
    font-size: 22px;
  }

  /* Toast Notification Styling */
  #toast {
    display: none;
    position: fixed;
    bottom: 30px;
    right: 30px;
    background-color: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    z-index: 9999;
    font-weight: bold;
    transition: opacity 0.3s ease;
  }

  </style>
</head>

<body>

  <div class="header-bar">
  <button class="menu-button" onclick="toggleMenu()">☰</button>
  <div class="header-title">VTEC RENTALS</div>

  <div class="add-to-cart-button" onclick="viewCart()" style="display: flex; flex-direction: column; align-items: center; background: #E6B422; border: none; cursor: pointer;">
    <span style="font-size: 20px;">🛒</span>
    <span id="cart-count" style="font-size: 15px; color: red; margin-top: 2px;">0</span>
  </div>
</div>

  <!-- Gallery Section -->
  <div id="gallerySection" class="content-section active">
    <h2 style="text-align:center; margin-top:60px;"></h2>
    <div id="galleryDisplay"></div>
  </div>

  <!-- Menu -->
  <div class="menu" id="menu">
    <a onclick="loadGalleryByCategory('EVENT SETUP'); closeMenu();" href="javascript:void(0);">🎉 EVENT SETUP</a>
    <a onclick="loadGalleryByCategory('THRILL RIDES'); closeMenu();" href="javascript:void(0);">🏁 THRILL RIDES</a>
<a onclick="loadGalleryByCategory('PARTY BUS'); closeMenu();" href="javascript:void(0);">🚍 PARTY BUS</a>
    <a onclick="showSection('reviewsSection'); closeMenu();" href="javascript:void(0);">⭐️ REVIEWS</a>
    <a onclick="logoutUser(); closeMenu();" style="display:block; text-align:center; margin:10px auto; padding:10px 20px; background-color:red; color:white; border-radius:6px; cursor:pointer; text-decoration:none; width:80%; font-weight:bold;" href="javascript:void(0);">LOGOUT</a>
    <a onclick="login(); closeMenu();" class="admin-button" style="display:block; text-align:center; margin:10px auto; padding:10px 20px; background-color:#6200ea; color:white; border-radius:6px; text-decoration:none; width:80%; font-weight:bold;" href="javascript:void(0);">ADMIN</a>
  </div>

  <!-- Reviews Section -->
  <div id="reviewsSection" class="content-section" style="padding-top: 32.7px; background-color: black; color: white;">

  <div id="reviewFormContainer" style="
    max-width: 500px;
    margin: 10px auto 20px auto;
    background-color: #F1C232;
    padding: 5px;
    border-radius: 10px;
    color: black;">
    
    <form id="reviewForm" style="text-align: center;">
      <input type="text" id="reviewName" placeholder="Your Name" required
        style="width: 100%; padding: 8px; margin-bottom: 6px; border-radius: 6px; border: 1px solid #555; background-color: #fff; color: black; box-sizing: border-box;" />

      <textarea id="reviewComment" placeholder="Write your review..." required
        style="width: 100%; height: 60px; padding: 8px; margin-bottom: 6px; border-radius: 6px; border: 1px solid #555; background-color: #fff; color: black; box-sizing: border-box;"></textarea>

      <div id="starRating" style="font-size: 22px; margin-bottom: 6px; cursor: pointer; color: #ccc; letter-spacing: -2px;">
        <span data-value="1">★</span><span data-value="2">★</span><span data-value="3">★</span><span data-value="4">★</span><span data-value="5">★</span>
      </div>

      <button type="submit" style="background-color: #6200ea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
        Submit Review
      </button>
    </form>
  </div>

  <h1 style="text-align: center; color: #9b59b6; margin-top: 5px; margin-bottom: 10px;">REVIEWS</h1>

  <p id="reviewSubmitMsg" style="text-align: center; color: #7fff7f; margin-top: 0;"></p>

  <div id="reviewsContainer" style="max-width: 600px; margin: 0 auto; color: white;"></div>
</div>

<!-- Cart Modal -->
<div id="cartModal" style="display: none;"> <!-- Initially hidden -->
    <div>
        <h2>Your Cart</h2>
        <!-- Add your form fields like Name, Phone, Location here -->
        <div id="cartButtons">
            <button id="payFullPrice" class="payment-button">Pay Full Price Online</button>
            <button id="payDeposit" class="payment-button">Pay Deposit (25%) and Rest Upon Arrival</button>
        </div>
    </div>
</div>

<!-- Payment Options Modal (For Card Input) -->
<div id="paymentOptionsModal" style="display: none;">
    <h2>Enter Your Card Details</h2>
    <div id="card-element" style="margin-bottom: 20px;"></div>
    <button id="submitPayment" class="payment-button">Pay Now</button>
</div>

<script src="https://js.stripe.com/v3/"></script> <!-- Include Stripe.js -->

<script>
  let stripe;
  let elements;
  let card;

  document.addEventListener('DOMContentLoaded', function () {
    // Pay Full Price button click event
    document.getElementById('payFullPrice').addEventListener('click', () => {
      handlePayment('full');  // Trigger full payment
    });

    // Pay Deposit button click event
    document.getElementById('payDeposit').addEventListener('click', () => {
      handlePayment('deposit');  // Trigger deposit payment (25%)
    });

    // Initialize Stripe and Elements
    stripe = Stripe('your_stripe_publishable_key'); // Replace with your Stripe publishable key
    elements = stripe.elements();

    // Create an instance of the card Element
    card = elements.create('card', {
      style: {
        base: {
          color: '#32325d',
          fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
          fontSmoothing: 'antialiased',
          fontSize: '16px',
          '::placeholder': {
            color: '#aab7c4',
          },
        },
      },
    });

    // Mount the card input field to the DOM
    card.mount('#card-element');
  });

  // Function to handle Full Payment or Deposit Payment
  function handlePayment(paymentType) {
    const fields = [
      document.getElementById("customerName"),
      document.getElementById("customerPhone"),
      document.getElementById("customerLocation"),
      document.getElementById("rentalDateRange"),
      document.getElementById("startTime"),
      document.getElementById("endTime")
    ];

    let firstError = null;

    // Validate fields
    fields.forEach(field => {
      field.classList.remove("error");
      if (!field.value.trim()) {
        field.classList.add("error");
        if (!firstError) firstError = field;
      }
    });

    // If there's an error, focus on the first invalid field
    if (firstError) {
      firstError.focus();
      return;
    }

    // Get values of the fields
    const name = fields[0].value.trim();
    const phone = fields[1].value.trim();
    const location = fields[2].value.trim();
    const rentalDates = fields[3].value.trim();
    const startTime = fields[4].value.trim();
    const endTime = fields[5].value.trim();

    // Hide the Cart Modal after checkout button click
    const cartModal = document.getElementById('cartModal');
    cartModal.style.display = 'none';  // This closes the cart modal

    // Show Payment Options Modal for card details input
    const paymentOptionsModal = document.getElementById('paymentOptionsModal');
    paymentOptionsModal.style.display = 'block'; // Show the payment options modal

    // Calculate total (for simplicity, we assume cartTotal is a fixed value here)
    const cartTotal = 100; // Example total amount (this should come from your cart data)
    const paymentAmount = paymentType === 'full' ? cartTotal : cartTotal * 0.25; // If deposit, charge 25%

    // Create PaymentIntent for the amount
    fetch('/create-payment-intent', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ paymentAmount }) // Send the payment amount to the server
    })
    .then((response) => response.json())
    .then((data) => {
      const clientSecret = data.clientSecret;

      // Add an event listener to handle form submission
      document.getElementById('submitPayment').addEventListener('click', () => {
        handleStripePayment(clientSecret);
      });
    });
  }

  // Function to handle Stripe payment
  function handleStripePayment(clientSecret) {
    stripe.confirmCardPayment(clientSecret, {
      payment_method: {
        card: card,
      },
    })
    .then(function(result) {
      if (result.error) {
        alert(result.error.message);  // Handle any errors from Stripe
      } else {
        if (result.paymentIntent.status === 'succeeded') {
          alert("Payment successful!");
          completeBooking();
        }
      }
    });
  }

  // Function to finalize the booking and clear cart
  function completeBooking() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    localStorage.removeItem('cart'); // Clear the cart from local storage
    updateCartCount(); // Update cart count here (ensure this function exists)
  }

  // Function to send a message to Telegram bot
  function sendTelegramMessage(name, phone, location, rentalDates, startTime, endTime, paymentType) {
    const telegramBotToken = 'your_telegram_bot_token'; // Replace with your bot's token
    const chatId = 'your_chat_id'; // Replace with your chat ID

    const url = `https://api.telegram.org/bot${telegramBotToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(
      `User: ${name} | Phone: ${phone} | Location: ${location} | Rental Dates: ${rentalDates} | Start: ${startTime} | End: ${endTime} | Payment: ${paymentType}`
    )}`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          console.log('Message sent successfully!');
        } else {
          console.error('Error sending message:', data);
        }
      })
      .catch(error => console.error('Error:', error));
  }
    
    let currentUser = null;

    const firebaseConfig = {
  apiKey: "AIzaSyACGG7Wf-TwdoeAxjqxQ8iIdpmPegEtunY",
  authDomain: "vtec-rentals.firebaseapp.com",
  projectId: "vtec-rentals",
  storageBucket: "vtec-rentals.firebasestorage.app",
  messagingSenderId: "278776721799",
  appId: "1:278776721799:web:f70b283d8313cd84eca322"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'login.html';
      } else {
        currentUser = user;
        loadReviews(currentUser);
      }
    });

    function login() {
  const email = prompt('Enter admin email:');
  const password = prompt('Enter admin password:');

  firebase.auth().signInWithEmailAndPassword(email, password)
    .then(() => {
      window.location.href = 'dashboard.html';
    })
    .catch((error) => {
      let errorMessage = 'Authentication failed: ' + error.message;
      if (error.code === 'auth/wrong-password') {
        errorMessage = 'Incorrect password. Please try again.';
      } else if (error.code === 'auth/user-not-found') {
        errorMessage = 'No user found with this email. Please check and try again.';
      }
      alert(errorMessage);
    });
}

function toggleMenu() {
  const menu = document.getElementById('menu');
  menu.classList.toggle('show');
}

function closeMenu() {
  const menu = document.getElementById('menu');
  menu.classList.remove('show');
}

function loadGallery(containerId) {
  const galleryContainer = document.getElementById(containerId);
  galleryContainer.innerHTML = '';

  db.collection('gallery').onSnapshot((querySnapshot) => {
    const categories = {};

    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const imageUrl = data.url;
      const name = data.name || 'Unnamed';
      const price = data.price || 0;
      const category = data.category || 'Uncategorized';

      if (!categories[category]) {
        categories[category] = [];
      }
      categories[category].push({ imageUrl, name, price });
    });

    let galleryHTML = '';

    for (const category in categories) {
      galleryHTML += `
        <div class="gallery-category">
          <h3>${category}</h3>
          <div class="gallery-wrapper">
            <div class="gallery-grid" id="gallery-${category}"></div>
          </div>
        </div>
      `;

      const categoryContainer = document.getElementById(`gallery-${category}`);
      categories[category].forEach((item) => {
        categoryContainer.innerHTML += `
          <div class="product-card">
            <img src="${item.imageUrl}" alt="${item.name}">
            <div class="product-info">
              <div class="product-name">${item.name}</div>
              <div class="product-price">$${item.price.toFixed(2)}</div>
              <button onclick="addToCart('${item.name}', ${item.price}, '${item.imageUrl}')">Add to Cart</button>
            </div>
          </div>
        `;
      });
    }

    galleryContainer.innerHTML = galleryHTML;  // Efficiently inject the full HTML after building it
  });
}

window.onload = function() {
  loadGalleryByCategory('EVENT SETUP');
  updateCartCount();

  flatpickr("#rentalDateRange", {
    mode: "range",
    dateFormat: "Y-m-d",
    minDate: "today",
    onClose: function(selectedDates) {
      if (selectedDates.length === 2) {
        const [start, end] = selectedDates;
        let days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        days = Math.max(days, 1); // Ensure at least 1 day charge
        if (days < 1) {
          alert("Minimum rental is 1 day.");
          return;
        }

        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        cart.forEach(item => {
          item.days = days;
          item.totalPrice = item.price * days;
        });

        localStorage.setItem('cart', JSON.stringify(cart));
        viewCart();
      }
    }
  });
};
    
let selectedRating = 0;

// Handle star rating UI
document.querySelectorAll('#starRating span').forEach(star => {
  star.addEventListener('click', () => {
    selectedRating = parseInt(star.getAttribute('data-value'));  // Set rating value on click
    // Update star colors based on selection
    document.querySelectorAll('#starRating span').forEach(s => {
      s.style.color = parseInt(s.getAttribute('data-value')) <= selectedRating ? '#f39c12' : '#ccc';
    });
  });
});

// Handle review form submission
document.getElementById('reviewForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const user = firebase.auth().currentUser;
  if (!user) {
    alert("You must be logged in to submit a review.");
    return;
  }

  const name = document.getElementById('reviewName').value.trim();
  const comment = document.getElementById('reviewComment').value.trim();
  const msg = document.getElementById('reviewSubmitMsg');

  // Check for required fields and star rating
  if (!name || !comment || selectedRating === 0) {
    msg.style.color = "red";
    msg.textContent = "Please fill all fields and select a star rating.";
    return;
  }

  try {
    // Add the review to Firestore
    await db.collection('reviews').add({
      name,
      comment,
      rating: selectedRating,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      uid: user.uid
    });

    // Update UI message and reset fields
    msg.style.color = "green";
    msg.textContent = "Thank you for your review!";
    document.getElementById('reviewForm').reset();
    selectedRating = 0;
    document.querySelectorAll('#starRating span').forEach(s => s.style.color = '#ccc');

    // Refresh reviews immediately after submission
    loadReviews(user);

  } catch (error) {
    console.error("Error submitting review:", error);
    msg.style.color = "red";
    msg.textContent = "Error submitting review.";
  }
});

// Function to load and display reviews
function loadReviews(user) {
  const container = document.getElementById('reviewsContainer');
  container.innerHTML = ''; // Clear any existing reviews

  db.collection('reviews').orderBy('timestamp', 'desc').get().then(snapshot => {
    if (snapshot.empty) {
      container.innerHTML = '<p>No reviews yet.</p>';
      return;
    }

    snapshot.forEach(doc => {
      const data = doc.data();
      const canDelete = user && data.uid === user.uid; // Check if the logged-in user can delete the review

      const reviewDiv = document.createElement('div');
      reviewDiv.style.borderBottom = '1px solid #ddd';
      reviewDiv.style.padding = '10px 0';

      // Display stars based on the rating
      const stars = '★'.repeat(data.rating) + '☆'.repeat(5 - data.rating);

      reviewDiv.innerHTML = `
        <strong>${data.name}</strong> <span style="color: #f39c12;">${stars}</span><br/>
        <p>${data.comment}</p>
      `;

      // Add delete button if the user can delete the review
      if (canDelete) {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.style.backgroundColor = '#e74c3c';
        delBtn.style.color = 'white';
        delBtn.style.border = 'none';
        delBtn.style.padding = '5px 10px';
        delBtn.style.borderRadius = '4px';
        delBtn.style.cursor = 'pointer';

        delBtn.addEventListener('click', () => deleteReview(doc.id)); // Add delete logic

        reviewDiv.appendChild(delBtn); // Append the delete button
      }

      container.appendChild(reviewDiv);
    });
  }).catch(error => {
    console.error('Error loading reviews:', error);
    container.innerHTML = '<p>Error loading reviews.</p>';
  });
}

// Function to delete review
function deleteReview(docId) {
  const user = firebase.auth().currentUser;
  if (!user) {
    alert('You must be logged in to delete reviews.');
    return;
  }

  if (confirm("Are you sure you want to delete this review?")) {
    db.collection('reviews').doc(docId).get().then(doc => {
      if (doc.exists && doc.data().uid === user.uid) {
        db.collection('reviews').doc(docId).delete()
          .then(() => {
            alert('Review deleted.');
            loadReviews(user); // Reload reviews after deletion
          })
          .catch(error => {
            alert('Error deleting review: ' + error.message);
          });
      } else {
        alert("You can only delete your own reviews.");
      }
    });
  }
}


function loadReviews(user) {
  const container = document.getElementById('reviewsContainer');
  container.innerHTML = '';  // Clear existing reviews

  db.collection('reviews').orderBy('timestamp', 'desc').get().then(snapshot => {
    if (snapshot.empty) {
      container.innerHTML = '<p>No reviews yet.</p>';
      return;
    }

    snapshot.forEach(doc => {
      const data = doc.data();
      const canDelete = user && data.uid === user.uid; // Check if the user can delete

      const reviewDiv = document.createElement('div');
      reviewDiv.style.borderBottom = '1px solid #ddd';
      reviewDiv.style.padding = '10px 0';

      // Display stars based on the rating
      const stars = '★'.repeat(data.rating) + '☆'.repeat(5 - data.rating);

      reviewDiv.innerHTML = `
        <strong>${data.name}</strong> <span style="color: #f39c12;">${stars}</span><br/>
        <p>${data.comment}</p>
      `;

      // Add delete button if the user is the owner
      if (canDelete) {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.style.backgroundColor = '#e74c3c';
        delBtn.style.color = 'white';
        delBtn.style.border = 'none';
        delBtn.style.padding = '5px 10px';
        delBtn.style.borderRadius = '4px';
        delBtn.style.cursor = 'pointer';
        delBtn.onclick = () => deleteReview(doc.id);  // Attach delete function
        reviewDiv.appendChild(delBtn);
      }

      container.appendChild(reviewDiv);  // Append review to container
    });
  }).catch(error => {
    console.error('Error loading reviews:', error);
    container.innerHTML = '<p>Error loading reviews.</p>';
  });
}

function deleteReview(docId) {
  const user = firebase.auth().currentUser;
  if (!user) {
    alert('You must be logged in to delete reviews.');
    return;
  }

  db.collection('reviews').doc(docId).get().then(doc => {
    if (doc.exists && doc.data().uid === user.uid) {
      db.collection('reviews').doc(docId).delete()
        .then(() => {
          alert('Review deleted.');
          loadReviews(user); // Reload reviews after deletion
        })
        .catch(error => {
          alert('Error deleting review: ' + error.message);
        });
    } else {
      alert("You can only delete your own reviews.");
    }
  });
}

    function loadGalleryByCategory(categoryFilter) {
  const galleryContainer = document.getElementById('galleryDisplay');
  galleryContainer.innerHTML = '';

  const qtyMap = {
    "CROSSBACK CHAIRS": {
      options: [10, 20, 50, 100],
      prices: { 10: 30, 20: 55, 50: 120, 100: 200 }
    },
    "PLASTIC TABLES": {
      options: [2, 4, 6],
      prices: { 2: 20, 4: 35, 6: 50 }
    },
    "Podium": {
      options: [1, 2, 3],
      prices: { 1: 15, 2: 28, 3: 40 }
    },
    "Plates": {
      options: [10, 20, 30, 50],
      prices: { 10: 10, 20: 18, 30: 25, 50: 35 }
    },
    "Lights": {
      options: [1, 5, 10],
      prices: { 1: 10, 5: 45, 10: 80 }
    },
    "Beach Umbrella": {
      options: [1, 2, 4],
      prices: { 1: 12, 2: 20, 4: 35 }
    },
    "Bluetooth Speaker": {
      options: [1, 2],
      prices: { 1: 30, 2: 55 }
    },
    "Tents": {
      options: [1, 2, 3],
      prices: { 1: 100, 2: 180, 3: 250 }
    },
    "Portable Bar": {
      options: [1, 2],
      prices: { 1: 50, 2: 90 }
    },
    "Outdoor Fan": {
      options: [1, 2, 4],
      prices: { 1: 15, 2: 25, 4: 40 }
    },
    "Warm Pan": {
      options: [2, 4, 6],
      prices: { 2: 10, 4: 18, 6: 25 }
    }
  };

  db.collection('gallery')
    .where('category', '==', categoryFilter)
    .get()
    .then((querySnapshot) => {
      if (querySnapshot.empty) {
        galleryContainer.innerHTML = `<p style="text-align:center;">No items found in "${categoryFilter}".</p>`;
        return;
      }

      galleryContainer.innerHTML = `
        <div class="gallery-category">
          <h3>${categoryFilter}</h3>
          <div class="gallery-wrapper">
            <div class="gallery-grid" id="gallery-${categoryFilter}"></div>
          </div>
        </div>
      `;

      const categoryContainer = document.getElementById(`gallery-${categoryFilter}`);

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const imageUrl = data.url;
        const name = data.name || 'Unnamed';
        const itemId = name.replace(/\s+/g, '-');

        let quantityOptions = [1];
        let quantityPrices = { 1: data.price || 0 };

        if (qtyMap[name]) {
          quantityOptions = qtyMap[name].options;
          quantityPrices = qtyMap[name].prices;
        }

        const optionsHTML = quantityOptions.map(qty =>
          `<option value="${qty}">${qty}</option>`
        ).join('');

        categoryContainer.innerHTML += `
          <div class="product-card">
            <img src="${imageUrl}" alt="${name}">
            <div class="product-info">
              <div class="product-name">${name}</div>
              <div class="product-price">
                Total: $<span id="price-${itemId}">${quantityPrices[quantityOptions[0]].toFixed(2)}</span>
              </div>
              <select id="qty-${itemId}" onchange="updateManualPrice('${itemId}', ${JSON.stringify(quantityPrices).replace(/"/g, '&quot;')})">
                ${optionsHTML}
              </select>
              <button onclick="addToCartWithQty('${name}', 0, '${imageUrl}')">Add to Cart</button>
            </div>
          </div>
        `;
      });
    })
    .catch((error) => {
      console.error("Error loading gallery:", error);
    });

  showSection('gallerySection');
}

// Function to update price based on selected quantity
function updateManualPrice(itemId, priceMap) {
  const qty = document.getElementById(`qty-${itemId}`).value;
  const price = priceMap[qty] || 0;
  document.getElementById(`price-${itemId}`).textContent = price.toFixed(2);
}

// Function to add item to the cart with selected quantity
function addToCartWithQty(name, _, imageUrl) {
  const itemId = name.replace(/\s+/g, '-');
  const qty = parseInt(document.getElementById(`qty-${itemId}`).value) || 1;
  const price = parseFloat(document.getElementById(`price-${itemId}`).textContent.replace(/,/g, ''));
  const totalPrice = price * qty; // Price for the selected quantity

  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  // Prevent adding the same item with the same quantity
  const duplicate = cart.find(item => item.name === name && item.quantity === qty);
  if (duplicate) {
    alert("This item is already in the cart with the selected quantity.");
    return;
  }

  // Add or update item in the cart
  const existingItem = cart.find(item => item.name === name);
  if (existingItem) {
    existingItem.quantity = qty;
    existingItem.price = price;
    existingItem.totalPrice = totalPrice;
  } else {
    cart.push({ name, price, imageUrl, quantity: qty, totalPrice });
  }

  localStorage.setItem('cart', JSON.stringify(cart));
  alert(`${name} added to cart.`);
  updateCartCount();
}

// Function to update cart item count
function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const count = cart.reduce((total, item) => total + item.quantity, 0);
  document.getElementById('cart-count').textContent = count;
}

    // Add item to cart with selected quantity
function addToCartWithQty(name, _, imageUrl) {
  const itemId = name.replace(/\s+/g, '-');
  const qty = parseInt(document.getElementById(`qty-${itemId}`).value) || 1;
  const price = parseFloat(document.getElementById(`price-${itemId}`).textContent.replace(/,/g, ''));
  const totalPrice = price * qty; // Total price for the selected quantity

  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  // 🔒 Prevent same item with the same quantity
  const duplicate = cart.find(item => item.name === name && item.quantity === qty);
  if (duplicate) {
    showToast("MAXIMUM AMOUNT REACHED", "error");
    return;
  }

  // 🛠 Update if same item but different quantity
  const existingItem = cart.find(item => item.name === name);
  if (existingItem) {
    existingItem.quantity = qty;
    existingItem.price = price;
    existingItem.totalPrice = totalPrice;
  } else {
    cart.push({ name, price, imageUrl, quantity: qty, totalPrice });
  }

  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartCount();
  showToast("Added to cart", "success");
}

// Update price when quantity is selected
function updateManualPrice(itemId, priceMap) {
  const qty = document.getElementById(`qty-${itemId}`).value;
  const price = priceMap[qty] || 0;
  document.getElementById(`price-${itemId}`).textContent = price.toFixed(2);
}

// Update price for multi-quantity items
function updatePrice(itemId, basePrice) {
  const qty = parseInt(document.getElementById(`qty-${itemId}`).value) || 1;
  const total = qty * basePrice;
  document.getElementById(`price-${itemId}`).textContent = total.toFixed(2);
}

// Load reviews from Firestore and allow users to delete their own reviews
function loadReviews(user) {
  const container = document.getElementById('reviewsContainer');
  container.innerHTML = ''; // Clear any existing reviews

  db.collection('reviews').orderBy('timestamp', 'desc').get().then(snapshot => {
    if (snapshot.empty) {
      container.innerHTML = '<p>No reviews yet.</p>';
      return;
    }

    snapshot.forEach(doc => {
      const data = doc.data();
      const canDelete = user && data.uid === user.uid; // Check if the logged-in user can delete the review

      const reviewDiv = document.createElement('div');
      reviewDiv.style.borderBottom = '1px solid #ddd';
      reviewDiv.style.padding = '10px 0';

      const stars = '★'.repeat(data.rating) + '☆'.repeat(5 - data.rating);

      reviewDiv.innerHTML = `
        <strong>${data.name}</strong> <span style="color: #f39c12;">${stars}</span><br/>
        <p>${data.comment}</p>
      `;

      // Add delete button if the user can delete the review
      if (canDelete) {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.style.backgroundColor = '#e74c3c';
        delBtn.style.color = 'white';
        delBtn.style.border = 'none';
        delBtn.style.padding = '5px 10px';
        delBtn.style.borderRadius = '4px';
        delBtn.style.cursor = 'pointer';
        delBtn.onclick = () => deleteReview(doc.id); // Attach delete logic
        reviewDiv.appendChild(delBtn); // Append the delete button
      }

      container.appendChild(reviewDiv);
    });
  }).catch(error => {
    console.error('Error loading reviews:', error);
    container.innerHTML = '<p>Error loading reviews.</p>';
  });
}

// Delete review (without confirmation)
function deleteReview(docId) {
  const user = firebase.auth().currentUser;
  if (!user) {
    alert('You must be logged in to delete reviews.');
    return;
  }

  db.collection('reviews').doc(docId).get().then(doc => {
    if (doc.exists && doc.data().uid === user.uid) {
      db.collection('reviews').doc(docId).delete()
        .then(() => {
          alert('Review deleted.');
          loadReviews(user); // Reload reviews after deletion
        })
        .catch(error => {
          alert('Error deleting review: ' + error.message);
        });
    } else {
      alert("You can only delete your own reviews.");
    }
  });
}

// Show section (Switch active sections)
function showSection(sectionId) {
  document.querySelectorAll('.content-section').forEach(section => {
    section.classList.remove('active');
  });
  document.getElementById(sectionId).classList.add('active');
}

// Logout user
function logoutUser() {
  firebase.auth().signOut().then(() => {
    window.location.href = 'login.html';
  });
}

// Add item to the cart
function addToCart(name, price, imageUrl) {
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  const existingItem = cart.find(item => item.name === name);
  if (existingItem) {
    existingItem.quantity += 1;
  } else {
    cart.push({ name, price, imageUrl, quantity: 1 });
  }
  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartCount();
  alert(`${name} added to cart.`);
}

// Update cart item count
function updateCartCount() {
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  const count = cart.reduce((total, item) => total + item.quantity, 0);
  document.getElementById('cart-count').textContent = count;
}

// Update rental duration and prices
function updateRentalDuration() {
  const startDateInput = document.getElementById('rentalStartDate');
  const endDateInput = document.getElementById('rentalEndDate');

  if (!startDateInput.value || !endDateInput.value) return;

  const start = new Date(startDateInput.value);
  const end = new Date(endDateInput.value);
  const msPerDay = 1000 * 60 * 60 * 24;
  const days = Math.ceil((end - start) / msPerDay);

  if (isNaN(days) || days < 1) {
    alert("Minimum rental period is 1 full day.");
    return;
  }

  let cart = JSON.parse(localStorage.getItem('cart')) || [];

  cart.forEach(item => {
    item.days = days;
    item.totalPrice = item.price * days; // Don't multiply by quantity again
  });

  localStorage.setItem('cart', JSON.stringify(cart));
  viewCart(); // Update UI
}

function viewCart() {
  const modal = document.getElementById('cartModal');
  const container = document.getElementById('cartItemsContainer');
  const totalElem = document.getElementById('cartTotal');
  container.innerHTML = '';

  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  if (cart.length === 0) {
    container.innerHTML = '<p>Your cart is empty.</p>';
    totalElem.textContent = '';
  } else {
    let total = 0;

    cart.forEach((item, index) => {
      total += item.totalPrice || (item.price * item.quantity);

      const itemDiv = document.createElement('div');
      itemDiv.style.display = 'flex';
      itemDiv.style.alignItems = 'center';
      itemDiv.style.justifyContent = 'space-between';
      itemDiv.style.padding = '8px 0';
      itemDiv.style.borderBottom = '1px solid #eee';

      const img = document.createElement('img');
      img.src = item.imageUrl;
      img.alt = item.name;
      img.style.width = '50px';
      img.style.height = '50px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '6px';
      img.style.marginRight = '8px';

      const infoDiv = document.createElement('div');
      infoDiv.style.flexGrow = '1';
      infoDiv.style.display = 'flex';
      infoDiv.style.alignItems = 'center';
      infoDiv.style.justifyContent = 'space-between';

      const nameSpan = document.createElement('span');
      nameSpan.textContent = item.name;

      const quantityText = document.createElement('span');
      quantityText.textContent = `Qty: ${item.quantity}`;
      quantityText.style.marginLeft = '10px';

      const priceSpan = document.createElement('span');
      priceSpan.textContent = `$${(item.totalPrice || item.price).toLocaleString(undefined, { minimumFractionDigits: 2 })} (${item.days || 1} day${item.days > 1 ? 's' : ''})`;
      priceSpan.style.marginLeft = '10px';
      priceSpan.style.fontWeight = 'bold';

      const controlsDiv = document.createElement('div');
      controlsDiv.style.display = 'flex';
      controlsDiv.style.alignItems = 'center';

      const removeBtn = document.createElement('button');
      removeBtn.textContent = '✖';
      removeBtn.style.color = 'red';
      removeBtn.style.marginLeft = '8px';
      removeBtn.onclick = () => removeItem(index);

      controlsDiv.appendChild(quantityText);
      controlsDiv.appendChild(removeBtn);

      infoDiv.appendChild(nameSpan);
      infoDiv.appendChild(priceSpan);

      itemDiv.appendChild(img);
      itemDiv.appendChild(infoDiv);
      itemDiv.appendChild(controlsDiv);

      container.appendChild(itemDiv);
    });

    totalElem.textContent = `Total: $${total.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
  } // ✅ This was missing!

  modal.style.display = 'block';
}

function removeItem(index) {
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  if (cart[index]) {
    cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    viewCart();
  }
}

  // Function to finalize the booking and clear cart
  function completeBooking() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    localStorage.removeItem('cart'); // Clear the cart from local storage
    updateCartCount(); // Update cart count here (ensure this function exists)
  }

  // Function to send a message to Telegram bot
  function sendTelegramMessage(name, phone, location, rentalDates, startTime, endTime, paymentType) {
    const telegramBotToken = 'your_telegram_bot_token'; // Replace with your bot's token
    const chatId = 'your_chat_id'; // Replace with your chat ID

    const url = `https://api.telegram.org/bot${telegramBotToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(
      `User: ${name} | Phone: ${phone} | Location: ${location} | Rental Dates: ${rentalDates} | Start: ${startTime} | End: ${endTime} | Payment: ${paymentType}`
    )}`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.ok) {
          console.log('Message sent successfully!');
        } else {
          console.error('Error sending message:', data);
        }
      })
      .catch(error => console.error('Error:', error));
  }

    function showToast(message = "ADDED TO CART", type = "success") {
  const toast = document.getElementById('toast');
  toast.textContent = message;

  // Color by type
  toast.style.backgroundColor = type === "error" ? "#dc3545" : "#28a745"; // red or green

  toast.style.display = 'block';
  toast.style.opacity = '1';

  setTimeout(() => {
    toast.style.opacity = '0';
  }, 2000);

  setTimeout(() => {
    toast.style.display = 'none';
  }, 2500);
}
  </script>
  </body>
</html>
